import pendulum
import boto3
import json
import yaml
import requests
from urllib3.util.retry import Retry
from requests.adapters import HTTPAdapter
import logging
from pydantic import SecretStr
from typing import Any


logger = logging.getLogger(__name__)

class OpenWeatherApiClient:
    def __init__(self, base_url: str, api_key: SecretStr):
        self.base_url = base_url.rstrip('/')
        self.api_key = api_key

        self.session = requests.Session()

        retries = Retry(total=5, backoff_factor=1, allowed_methods=["GET"], status_forcelist=[500, 502, 503, 504])

        adapter = HTTPAdapter(max_retries=retries)
        self.session.mount("http://", adapter=adapter)
        self.session.mount("https://", adapter=adapter)

        self.session.params = {
            "appid": api_key.get_secret_value()
        }

        logger.info("Initialize OpenWeatherApiCleint and strart requests session")

    def get_historical_airpollution_data(self, city: str, lat: str|int|float, lon: str|int|float, start_ts: int, end_ts: int) -> dict[str, Any]:

        params = {
            "lat": lat,
            "lon": lon,
            "start": start_ts,
            "end": end_ts
        }

        try:
            logger.info(f"Fetching data for city={city}(lat={lat}, lon={lon}), range={start_ts}-{end_ts}")

            response = self.session.get(self.base_url, params=params, timeout=10)
            response.raise_for_status()

            return response.json()

        except requests.HTTPError as e:
            logger.error(f"HTTP Error from OpenWeatherMap: {e}")
            raise
        except Exception as e:
            logger.error(f"Unexpected Error: {e}")
            raise